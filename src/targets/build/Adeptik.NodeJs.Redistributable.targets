<?xml version="1.0" encoding="utf-8" standalone="no"?>

<!-- Downloads NodeJs distribution to use in project -->
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Download NodeJS distrib & unpack -->
  <Target Name="InstallNodeJs" Returns="$(NodeJsExecutablePath)">
    <Error Text="NodeJsVersion property not set." Condition="'$(NodeJsVersion)' == ''" />
    <InstallNodeJs NodeJsVersion="$(NodeJsVersion)" WorkingDirectoryPath="$(NodeJsDistTempPath)">
      <Output TaskParameter="NodeJsPath" PropertyName="NodeJsPath"></Output>
      <Output TaskParameter="GlobalNodeModulesPath" PropertyName="GlobalNodeModulesPath"></Output>
      <Output TaskParameter="NodeExecutable" PropertyName="NodeExecutable"></Output>
      <Output TaskParameter="NPMExecutable" PropertyName="NPMExecutable"></Output>
    </InstallNodeJs>
    <Message Text="Working with NodeJS at $(NodeJsPath)"></Message>
  </Target>

  <!-- Install yarn using NPM -->
  <Target Name="InstallYarn" DependsOnTargets="InstallNodeJs">
    <Exec Command="$(NPMExecutable) install -g yarn@$(YarnVersion)"
          WorkingDirectory="$(NodeJsPath)"
          ConsoleToMSBuild="True"
    />
    <PropertyGroup>
      <YarnExecutable>$(NodeExecutable) $(GlobalNodeModulesPath)yarn/bin/yarn.js</YarnExecutable>
    </PropertyGroup>
  </Target>

  <!-- Install project packages using yarn -->
  <Target Name="YarnInstall" DependsOnTargets="InstallYarn">
    <Exec Command="$(YarnExecutable) install"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!-- Run yarn command if specified -->
  <Target Name="YarnRun" DependsOnTargets="YarnInstall"  BeforeTargets="CoreCompile" Condition="'$(YarnBuildCommand)' != '' ">
    <Exec Command="$(YarnExecutable) $(YarnBuildCommand)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!--Setup yarn build dependences-->
  <PropertyGroup>
    <PrepareForBuildDependsOn>YarnRun;$(PrepareForBuildDependsOn)</PrepareForBuildDependsOn>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);YarnRun</CoreCompileDependsOn>
  </PropertyGroup>

</Project>