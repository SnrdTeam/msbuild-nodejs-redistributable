<?xml version="1.0" encoding="utf-8" standalone="no"?>

<!-- Downloads NodeJs distribution to use in project -->
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Output properties -->
  <PropertyGroup>
    <NodeJsPath></NodeJsPath>
    <GlobalNodeModulesPath></GlobalNodeModulesPath>
    <NodeExecutable></NodeExecutable>
    <NPMScriptPath></NPMScriptPath>

    <ExecuteCommandYarn></ExecuteCommandYarn>
  </PropertyGroup>

  <!-- Download NodeJS distrib & unpack -->
  <Target Name="InstallNodeJs">
    <Error Text="NodeJsDistVersion property not set." Condition="'$(NodeJsDistVersion)' == ''" />
    <InstallNodeJs NodeJsVersion="$(NodeJsDistVersion)" WorkingDirectoryPath="$(NodeJsDistTempPath)">
      <Output TaskParameter="NodeJsPath" PropertyName="NodeJsPath"/>
      <Output TaskParameter="GlobalNodeModulesPath" PropertyName="GlobalNodeModulesPath"/>
      <Output TaskParameter="NodeExecutable" PropertyName="NodeExecutable"/>
      <Output TaskParameter="NPMScriptPath" PropertyName="NPMScriptPath"/>
    </InstallNodeJs>
    <Message Text="Working with NodeJS at $(NodeJsPath)"/>
  </Target>
  
  <!-- Install YARN globally -->
  <Target Name="InstallYarn" DependsOnTargets="InstallNodeJs">
    <NPMInstallGlobal NPMScriptPath="$(NPMScriptPath)" NodeExecutable="$(NodeExecutable)" PackageName="yarn" PackageVersion="$(YarnVersion)" />
    <PropertyGroup>
      <ExecuteCommandYarn>$(NodeExecutable) $(GlobalNodeModulesPath)/yarn/bin/yarn.js</ExecuteCommandYarn>
    </PropertyGroup>
  </Target>
  
  <!-- Install project packages using yarn -->
  <Target Name="YarnInstall" DependsOnTargets="InstallYarn">
    <Exec Command="$(ExecuteCommandYarn) install"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!-- Run yarn command if specified -->
  <Target Name="YarnRun" DependsOnTargets="YarnInstall"  BeforeTargets="CoreCompile" Condition="'$(YarnBuildCommand)' != '' ">
    <Exec Command="$(ExecuteCommandYarn) $(YarnBuildCommand)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!--Setup yarn build dependences-->
  <PropertyGroup>
    <PrepareForBuildDependsOn>YarnRun;$(PrepareForBuildDependsOn)</PrepareForBuildDependsOn>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);YarnRun</CoreCompileDependsOn>
  </PropertyGroup>

  <!-- Generate Jasmine test run config for shell -->
  <Target Name="GenerateJasmineConfigAndStartup" DependsOnTargets="InstallNodeJs" BeforeTargets="Build">
    <GenerateJasmineConfig BuildPath="$(OutDir)"/>
    <WriteLinesToFile File="$(OutDir).execCfg.json" Overwrite="true" Lines="{&quot;NodeExecuteFile&quot;:&quot;$([MSBuild]::Escape('$(NodeExecutable.Replace('\', '\\'))'))&quot;,;&quot;JasmineLauncher&quot;:&quot;$([MSBuild]::Escape('$(TargetDir.Replace('\', '\\'))JasmineExecutor.js'))&quot;,;&quot;JasmineConfig&quot;:&quot;$([MSBuild]::Escape('$(OutDir.Replace('\', '\\'))jasmine.json'))&quot;}" />
  </Target>
</Project>