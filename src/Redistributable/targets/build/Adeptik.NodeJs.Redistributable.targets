<?xml version="1.0" encoding="utf-8" standalone="no"?>

<!-- Downloads NodeJs distribution to use in project -->
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Output properties -->
  <PropertyGroup>
    <NodeJsPath></NodeJsPath>
    <GlobalNodeModulesPath></GlobalNodeModulesPath>
    <NodeExecutable></NodeExecutable>
    <NPMExecutable></NPMExecutable>

    <YarnExecutable></YarnExecutable>
  </PropertyGroup>

  <!-- Download NodeJS distrib & unpack -->
  <Target Name="InstallNodeJs">
    <Error Text="NodeJsDistVersion property not set." Condition="'$(NodeJsDistVersion)' == ''" />
    <InstallNodeJs NodeJsVersion="$(NodeJsDistVersion)" WorkingDirectoryPath="$(NodeJsDistTempPath)">
      <Output TaskParameter="NodeJsPath" PropertyName="NodeJsPath"/>
      <Output TaskParameter="GlobalNodeModulesPath" PropertyName="GlobalNodeModulesPath"/>
      <Output TaskParameter="NodeExecutable" PropertyName="NodeExecutable"/>
      <Output TaskParameter="NPMExecutable" PropertyName="NPMExecutable"/>
    </InstallNodeJs>
    <Message Text="Working with NodeJS at $(NodeJsPath)"/>
  </Target>
  
  <!-- Install globally libs (YARN and Jasmine) -->
  <Target Name="InstallGlobalLibs" DependsOnTargets="InstallNodeJs">
    <InstallGlobalLibs NodeExecutable="$(NodeExecutable)" GlobalNodeModulesPath="$(GlobalNodeModulesPath)" NPMExecutable="$(NPMExecutable)" JasmineVersion="$(JasmineVersion)" YarnVersion="$(YarnVersion)">
      <Output TaskParameter="YarnExecutable" PropertyName="YarnExecutable"/>
      <Output TaskParameter="JasmineExecutable" PropertyName="JasmineExecutable"/>
    </InstallGlobalLibs>
  </Target>

  <!-- Install project packages using yarn -->
  <Target Name="YarnInstall" DependsOnTargets="InstallGlobalLibs">
    <Exec Command="$(YarnExecutable) install"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!-- Run yarn command if specified -->
  <Target Name="YarnRun" DependsOnTargets="InstallGlobalLibs"  BeforeTargets="CoreCompile" Condition="'$(YarnBuildCommand)' != '' ">
    <Exec Command="$(YarnExecutable) $(YarnBuildCommand)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ConsoleToMSBuild="True" />
  </Target>

  <!--Setup yarn build dependences-->
  <PropertyGroup>
    <PrepareForBuildDependsOn>YarnRun;$(PrepareForBuildDependsOn)</PrepareForBuildDependsOn>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);YarnRun</CoreCompileDependsOn>
  </PropertyGroup>

  <!-- Generate Jasmine test run config -->
  <Target Name="GenerateJasmineConfigAndStartup" DependsOnTargets="InstallGlobalLibs"  AfterTargets="Build">
    <GenerateJasmineConfig BuildPath="$(OutDir)"/>
    <WriteLinesToFile File="$(OutDir)jasmine.cmd" Overwrite="true"
      Lines="$(JasmineExecutable)" />
  </Target>
</Project>